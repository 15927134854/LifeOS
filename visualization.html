<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>LifeOS 可视化</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .chart-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        svg {
            width: 100%;
            height: 500px;
        }

        .tooltip {
            position: absolute;
            width: 200px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>LifeOS 数据可视化</h1>

    <div class="chart-container">
        <h2>人生意义趋势</h2>
        <svg id="life-meaning-trend"></svg>
        <div class="tooltip" id="line-tooltip"></div>
    </div>

    <div class="chart-container">
        <h2>累计人生意义趋势</h2>
        <svg id="cumulative-life-meaning-trend"></svg>
        <div class="tooltip" id="line-tooltip"></div>
    </div>

    <div class="chart-container">
        <h2>每个价值目标的人生意義贡献</h2>
        <svg id="value-goal-contribution"></svg>
        <div class="tooltip" id="bar-tooltip"></div>
    </div>

    <div class="chart-container">
        <h2>每个价值目標の累计人生意義贡献</h2>
        <svg id="cumulative-value-goal-contribution"></svg>
        <div class="tooltip" id="bar-tooltip"></div>
    </div>

    <div class="chart-container">
        <h2>每个价值目標的人生意義贡献占比</h2>
        <svg id="value-goal-pie-chart"></svg>
        <div class="tooltip" id="pie-tooltip"></div>
    </div>

    <div class="chart-container">
        <h2>每个价值目標の累计人生意義贡献占比</h2>
        <svg id="cumulative-value-goal-pie-chart"></svg>
        <div class="tooltip" id="pie-tooltip"></div>
    </div>

    <div class="chart-container">
        <h2>生命周期阶段</h2>
        <div id="lifespan-stages"></div>
    </div>

    <div class="chart-container">
        <h2>推荐信息</h2>
        <div id="recommendation-info"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // 全局变量存储可视化数据
        window.visualizationData = {};

        // 页面加载时自动读取笔记
        window.onload = function() {
            fetch('goal/simulation_output.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络响应异常: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('加载的数据:', data);  // 添加日志输出

                    // 解析数据
                    const lifeMeaningData = data.life_meaning || [];
                    const cumulativeLifeMeaningData = data.cumulative_life_meaning || [];
                    
                    // 处理 life_meaning_by_goal 数据
                    const lifeMeaningByGoal = [];
                    if (data.life_meaning_by_goal && Array.isArray(data.life_meaning_by_goal)) {
                        // 直接使用数组数据
                        for (const entry of data.life_meaning_by_goal) {
                            if (typeof entry === 'object' && !Array.isArray(entry)) {
                                lifeMeaningByGoal.push(entry);
                            }
                        }
                    } else if (typeof data.life_meaning_by_goal === 'object' && !Array.isArray(data.life_meaning_by_goal)) {
                        // 如果是对象而不是数组，将其转换为单元素数组
                        lifeMeaningByGoal.push(data.life_meaning_by_goal);
                    }
                    
                    const cumulativeLifeMeaningByGoal = data.cumulative_life_meaning_by_goal || [];
                    const lifespanStages = data.lifespan_stages || [];

                    // 将数据附加到 window 对象，便于其他函数访问
                    window.visualizationData = {
                        lifeMeaningData,
                        cumulativeLifeMeaningData,
                        lifeMeaningByGoal,
                        cumulativeLifeMeaningByGoal,
                        lifespanStages
                    };

                    // 初始化图表
                    initializeCharts();
                })
                .catch(error => {
                    console.error('JSON数据加载失败:', error);
                    alert(`无法加载可视化数据: ${error.message}`);
                });
        };

        // 初始化图表
        function initializeCharts() {
            if (!window.visualizationData || !window.visualizationData.lifeMeaningData || window.visualizationData.lifeMeaningData.length === 0) {
                console.error('没有人生意义数据可供展示');
                alert('可视化数据缺失，请检查 simulation_output.json 是否正常生成');
                return;
            }
            
            // 获取饼图数据
            const pieData = generatePieData();
            
            // 绘制折线图
            drawLineChart('#life-meaning-trend', window.visualizationData.lifeMeaningData, '人生意義趋势');
            drawLineChart('#cumulative-life-meaning-trend', window.visualizationData.cumulativeLifeMeaningData, '累计人生意義趋势');
            
            // 绘制柱状图
            if (window.visualizationData.lifeMeaningByGoal && window.visualizationData.lifeMeaningByGoal.length > 0) {
                drawBarChart('#value-goal-contribution', window.visualizationData.lifeMeaningByGoal, '每个价值目標的人生意義贡献');
                drawBarChart('#cumulative-value-goal-contribution', window.visualizationData.cumulativeLifeMeaningByGoal, '每个价值目標の累计人生意義贡献');
            } else {
                console.error('没有价值目标数据可供展示');
                document.getElementById('value-goal-contribution').style.display = 'none';
                document.getElementById('cumulative-value-goal-contribution').style.display = 'none';
                document.querySelector('#value-goal-contribution + p').textContent = '暂无价值目标数据';
                document.querySelector('#cumulative-value-goal-contribution + p').textContent = '暂无累计价值目標データ';
            }
            
            // 绘制饼图
            if (pieData && pieData.length > 0) {
                drawPieChart('#value-goal-pie-chart', pieData, '每个价值目標的人生意義贡献占比');
                drawPieChart('#cumulative-value-goal-pie-chart', generateCumulativePieData(), '每个价值目標の累计人生意義贡献占比');
            } else {
                console.error('没有饼图数据可供展示');
                document.getElementById('value-goal-pie-chart').style.display = 'none';
                document.getElementById('cumulative-value-goal-pie-chart').style.display = 'none';
                document.querySelector('#value-goal-pie-chart + p').textContent = '暂无价值目標データ';
                document.querySelector('#cumulative-value-goal-pie-chart + p').textContent = '暂无累计价值目標データ';
            }
            
            // 显示生命周期阶段信息
            displayLifespanStages();
            
            // 添加推荐信息
            addRecommendationInfo();
        }

        // 绘制折线图函数
        function drawLineChart(selector, data, title) {
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            const x = d3.scaleLinear()
                .domain([0, data.length - 1])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data)]).nice()
                .range([height, 0]);

            const line = d3.line()
                .x((d, i) => x(i))
                .y(d => y(d));

            const svg = d3.select(selector)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // 添加 X 轴
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => `${d+1}周期`));

            // 添加 Y 轴
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).tickFormat(d => `${d}意義値`));

            // 添加网格线
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y)
                    .tickSize(-width)
                    .tickFormat("")
                );

            // 绘制折线
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line);

            // 添加数据点
            svg.selectAll("circle")
                .data(data)
                .enter().append("circle")
                .attr("cx", (d, i) => x(i))
                .attr("cy", d => y(d))
                .attr("r", 4)
                .attr("fill", "steelblue")
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`周期: ${event.offsetX}, 値: ${d.toFixed(2)}`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px")
                        .style("transform", "scale(1.1)");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(this)
                        .style("transform", "scale(1)");
                });

            // 添加标题
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .text(title);

            // 添加提示框
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
        }

        // 绘制柱状图函数
        function drawBarChart(selector, data, title) {
            const margin = {top: 20, right: 20, bottom: 80, left: 60};
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            // 如果没有数据，显示提示信息
            if (!data || data.length === 0) {
                const svg = d3.select(selector)
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);
                
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .text("暂无数据可供展示");
                
                return;
            }

            // 创建比例尺
            const x = d3.scaleBand()
                .domain(data.map((d, i) => i))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d3.max(Object.values(d)))]).nice()
                .range([height, 0]);

            // 创建 SVG 容器
            const svg = d3.select(selector)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // 添加 X 轴
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d => {
                        if (data[d] && typeof data[d] === 'object') {
                            return Object.keys(data[d])[0];
                        }
                        return d;
                    }));

            // 旋转 X 轴标签
            svg.selectAll(".tick text")
                .style("text-anchor", "end")
                .attr("dx", "-0.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");

            // 添加 Y 轴
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).tickFormat(d => `${d}意義値`));

            // 添加网格线
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y)
                    .tickSize(-width)
                    .tickFormat("")
                );

            // 绘制柱状图
            const bars = svg.selectAll(".bar")
                .data(data)
                .enter().append("g")
                .attr("class", "bar")
                .attr("transform", (d, i) => `translate(${x(i)},0)`);

            // 为每个数据点绘制柱子
            bars.selectAll("rect")
                .data(d => {
                    if (typeof d === 'object' && !Array.isArray(d)) {
                        return Object.entries(d);
                    }
                    return [];
                })
                .enter().append("rect")
                .attr("x", (d, i) => i * x.bandwidth() / 2)
                .attr("y", d => y(d[1]))
                .attr("width", x.bandwidth() / 2)
                .attr("height", d => height - y(d[1]))
                .attr("fill", (d, i) => d3.schemeCategory10[i % 10])
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`${d[0]}<br/>値: ${d[1].toFixed(2)}<br/><br/>意义说明：根据该周期内的人生行動与价值目標関连度総合計算で得出。`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px")
                        .style("transform", "scale(1.1)");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(this)
                        .style("transform", "scale(1)");
                });

            // 添加标题
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .text(title);

            // 添加提示框
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
        }

        // 绘制饼图函数
        function drawPieChart(selector, data, title) {
            const width = 900;
            const height = 500;
            const radius = Math.min(width, height) / 2 - 40;

            // 如果没有数据，显示提示信息
            if (!data || data.length === 0) {
                const svg = d3.select(selector)
                    .attr("width", width)
                    .attr("height", height);
                
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .text("暂无数据可供展示");
                
                return;
            }

            // 创建颜色比例尺
            const color = d3.scaleOrdinal(d3.schemeCategory10);

            // 创建饼图生成器
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            // 创建弧度生成器
            const arc = d3.arc()
                .innerRadius(radius * 0.4)
                .outerRadius(radius);

            // 创建标签位置
            const labelArc = d3.arc()
                .innerRadius(radius * 0.55)
                .outerRadius(radius * 0.55);

            // 清空容器
            const svg = d3.select(selector)
                .attr("width", width)
                .attr("height", height)
              .selectAll("*")
                .remove();

            // 创建饼图
            const g = svg.append("g")
                .attr("transform", `translate(${width/2},${height/2})`);

            // 绘制扇形
            const arcs = g.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc")
                .on("mouseover", function(event, d) {
                    // 放大当前扇形
                    d3.select(this).select("path")
                        .transition()
                        .duration(200)
                        .attr("transform", `scale(1.1) translate(-${d.x},${-d.y})`);
                    
                    // 显示提示框
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`<strong>${d.data.name}</strong><br/>値: ${d.data.value.toFixed(2)}<br/>百分比: ${(d.endAngle - d.startAngle) * 100 / (2 * Math.PI)}.toFixed(1)%<br/><br/>人生阶段: ${getLifeStage(d.data.value, d3.sum(data, d => d.value))}`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px")
                        .style("transform", "scale(1.1)");
                })
                .on("mouseout", function(d) {
                    // 恢复大小
                    d3.select(this).select("path")
                        .transition()
                        .duration(500)
                        .attr("transform", "scale(1)");
                    
                    // 隐藏提示框
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // 绘制路径
            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.name))
                .each(function(d) { this._current = d; });

            // 添加标签
            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .text(d => `${d.data.name}: ${(d.endAngle - d.startAngle) * 100 / (2 * Math.PI)}.toFixed(1)%`);

            // 添加图例
            const legend = g.append("g")
                .attr("transform", `translate(${radius + 60},-${radius})`)
                .selectAll(".legend")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0,${i * 25})`);

            // 图例颜色块
            legend.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", d => color(d.data.name));

            // 图例文字
            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .text(d => `${d.data.name}: ${(d.endAngle - d.startAngle) * 100 / (2 * Math.PI)}.toFixed(1)%`);

            // 添加标题
            g.append("text")
                .attr("y", -radius - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .text(title);

            // 添加生命周期阶段情報说明
            g.append("text")
                .attr("y", radius + 30)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("fill", "#666")
                .text("颜色表示人生阶段：核心价值（>40%）、重要目標（>25%）、成長領域（>10%）、探索方向（<=10%）");

            // 添加提示框
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
        }

        // 生成饼图数据
        function generatePieData() {
            if (!window.visualizationData || !window.visualizationData.lifeMeaningByGoal || window.visualizationData.lifeMeaningByGoal.length === 0) {
                console.log('没有价值目标数据可供展示');
                return [];
            }
            
            // 使用最新周期的数据
            const latestGoalData = window.visualizationData.lifeMeaningByGoal[window.visualizationData.lifeMeaningByGoal.length - 1];
            
            // 将数据转换为饼图需要的格式 {name: '', value: ''}
            const pieData = [];
            for (const [goal, value] of Object.entries(latestGoalData)) {
                pieData.push({
                    name: goal,
                    value: value
                });
            }
            
            return pieData;
        }
        
        // 生成累计饼图データ
        function generateCumulativePieData() {
            if (!window.visualizationData || !window.visualizationData.cumulativeLifeMeaningByGoal || window.visualizationData.cumulativeLifeMeaningByGoal.length === 0) {
                console.log('没有累计价值目標データ可供展示');
                return [];
            }
            
            // 使用最新周期的累计数据
            const latestCumulativeData = window.visualizationData.cumulativeLifeMeaningByGoal[window.visualizationData.cumulativeLifeMeaningByGoal.length - 1];
            
            // 将データ转换为饼図が必要なフォーマット {name: '', value: ''}
            const cumulativePieData = [];
            for (const [goal, value] of Object.entries(latestCumulativeData)) {
                cumulativePieData.push({
                    name: goal,
                    value: value
                });
            }
            
            return cumulativePieData;
        }
        
        // 显示生命周期阶段情報
        function displayLifespanStages() {
            const stageContainer = document.getElementById('lifespan-stages');
            if (!stageContainer) {
                console.error('找不到生命周期阶段容器');
                return;
            }
            
            // 清空现有内容
            stageContainer.innerHTML = '';
            
            // 如果没有生命周期阶段データ，显示默认提示
            if (!window.visualizationData || !window.visualizationData.lifespanStages || window.visualizationData.lifespanStages.length === 0) {
                const defaultStage = document.createElement('p');
                defaultStage.textContent = '暂无生命周期阶段信息';
                defaultStage.style.color = '#666';
                defaultStage.style.fontStyle = 'italic';
                stageContainer.appendChild(defaultStage);
                return;
            }
            
            // 创建タイトル
            const title = document.createElement('h3');
            title.textContent = '生命周期阶段情報';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '15px';
            stageContainer.appendChild(title);
            
            // 创建阶段リスト
            const stageList = document.createElement('ul');
            stageList.style.listStyleType = 'none';
            stageList.style.paddingLeft = '0';
            
            for (const stage of window.visualizationData.lifespanStages) {
                const listItem = document.createElement('li');
                listItem.style.margin = '8px 0';
                listItem.innerHTML = `<strong>${stage.stage_name}</strong>: ${stage.start_age} - ${stage.end_age} 岁`;
                stageList.appendChild(listItem);
            }
            
            stageContainer.appendChild(stageList);
        }
        
        // 添加推薦情報
        function addRecommendationInfo() {
            const container = document.getElementById('recommendation-info');
            container.textContent = 'ここに推奨情報が表示されます。';
        }
        
        // 辅助函数：根据値判断人生阶段
        function getLifeStage(value, total) {
            if (total === 0) return "探索方向";
            const ratio = value / total;
            if (ratio > 0.4) return "核心价值";
            if (ratio > 0.25) return "重要目標";
            if (ratio > 0.1) return "成長領域";
            return "探索方向";
        }
    </script>
</body>
</html>