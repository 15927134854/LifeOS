<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人生意义データ可视化</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        svg {
            background-color: #f9f9f9;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .grid path,
        .grid line {
            stroke: #ddd;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke-width: 2px;
            stroke-opacity: 0.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .dot {
            transition: all 0.3s ease-in-out;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body>

<h1>人生意義データ可视化</h1>

<!-- 图表容器 -->
<div id="charts">
    <h2>人生意義趋势</h2>
    <svg id="life-meaning-trend" width="900" height="500"></svg>

    <h2>累计人生意義趋势</h2>
    <svg id="cumulative-life-meaning-trend" width="900" height="500"></svg>

    <h2>每个价值目标的人生意義贡献</h2>
    <svg id="value-goal-contribution" width="900" height="500"></svg>

    <h2>每个价值目标的累计人生意義贡献</h2>
    <svg id="cumulative-value-goal-contribution" width="900" height="500"></svg>
</div>

<script>
    // 在页面加载时获取 simulation_output.json 数据
    window.onload = function() {
        fetch('goal/simulation_output.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Loaded data:', data);  // 添加日志输出

                // 解析数据
                const lifeMeaningData = data.life_meaning || [];
                const cumulativeLifeMeaningData = data.cumulative_life_meaning || [];
                const lifeMeaningByGoal = data.life_meaning_by_goal || [];
                const cumulativeLifeMeaningByGoal = data.cumulative_life_meaning_by_goal || [];

                // 绘制折线图
                drawLineChart('#life-meaning-trend', lifeMeaningData, '人生意義趋势');
                drawLineChart('#cumulative-life-meaning-trend', cumulativeLifeMeaningData, '累计人生意義趋势');

                // 绘制饼图
                if (lifeMeaningByGoal.length > 0) {
                    // 合并所有周期的数据，生成总贡献饼图
                    const aggregatedLifeMeaningByGoal = {};
                    lifeMeaningByGoal.forEach(entry => {
                        Object.entries(entry).forEach(([key, value]) => {
                            if (!aggregatedLifeMeaningByGoal[key]) {
                                aggregatedLifeMeaningByGoal[key] = 0;
                            }
                            aggregatedLifeMeaningByGoal[key] += value;
                        });
                    });

                    const pieData = Object.keys(aggregatedLifeMeaningByGoal).map(key => ({
                        name: key,
                        value: aggregatedLifeMeaningByGoal[key]
                    }));

                    drawPieChart('#value-goal-contribution', pieData, '每个价值目标的人生意義贡献');
                } else {
                    console.error('Invalid or missing life_meaning_by_goal data');
                }

                // 绘制累计饼图
                if (cumulativeLifeMeaningByGoal.length > 0) {
                    const aggregatedCumulativeLifeMeaningByGoal = {};
                    cumulativeLifeMeaningByGoal.forEach(entry => {
                        Object.entries(entry).forEach(([key, value]) => {
                            if (!aggregatedCumulativeLifeMeaningByGoal[key]) {
                                aggregatedCumulativeLifeMeaningByGoal[key] = 0;
                            }
                            aggregatedCumulativeLifeMeaningByGoal[key] += value;
                        });
                    });

                    const cumulativePieData = Object.keys(aggregatedCumulativeLifeMeaningByGoal).map(key => ({
                        name: key,
                        value: aggregatedCumulativeLifeMeaningByGoal[key]
                    }));

                    drawPieChart('#cumulative-value-goal-contribution', cumulativePieData, '每个价值目標の累计人生意義贡献');
                } else {
                    console.error('Invalid or missing cumulative_life_meaning_by_goal data');
                }
            })
            .catch(error => {
                console.error('Error loading JSON data:', error);
                alert(`Failed to load visualization data: ${error.message}`);
            });
    };

    // 绘制折线图函数
    function drawLineChart(selector, data, title) {
        const margin = {top: 20, right: 20, bottom: 40, left: 60};
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const x = d3.scaleLinear()
            .domain([0, data.length - 1])
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data)]).nice()
            .range([height, 0]);

        const line = d3.line()
            .x((d, i) => x(i))
            .y(d => y(d));

        const svg = d3.select(selector)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 添加 X 轴
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickFormat(d => `${d}周期`));  // 横轴显示为“周期”

        // 添加 Y 轴
        svg.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y).tickFormat(d => `${d}意义값`));  // 纵轴显示为“意义값”

        // 添加网格线
        svg.append("g")
            .attr("class", "grid")
            .call(makeGridLines(y, width)  // 传递 width 参数
                .tickSize(-width)
                .tickFormat("")
            );

        // 绘制折线
        svg.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", "steelblue");

        // 添加数据点
        svg.selectAll(".dot")
            .data(data)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("cx", (d, i) => x(i))
            .attr("cy", d => y(d))
            .attr("r", 4)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`값: ${d}`)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .style("transform", "scale(1.1)");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                d3.select(this)
                    .style("transform", "scale(1)");
            });

        // 添加标题
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - margin.top / 2)
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .text(title);

        // 添加提示框
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    }

    // 创建网格线
    function makeGridLines(scale, width) {  // 添加 width 参数
        return d3.axisLeft(scale)
            .tickSize(-width)
            .tickFormat("");
    }

    // 绘制柱状图函数
    function drawBarChart(selector, dataArray, title) {
        const margin = {top: 20, right: 20, bottom: 80, left: 60};
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        // 获取所有价值目标类别
        const categories = Object.keys(dataArray[0] || {});
        
        // 创建每个周期的数据映射
        const seriesData = dataArray.map((entry, index) => {
            return categories.map(category => ({
                name: category,
                value: entry[category],
                group: `기간 ${index + 1}`
            }));
        });

        const x0 = d3.scaleBand()
            .domain(seriesData.map((d, i) => `기간 ${i + 1}`))
            .range([0, width])
            .padding(0.2);

        const x1 = d3.scaleBand()
            .domain(categories)
            .range([0, x0.bandwidth()])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(seriesData, s => d3.sum(s, d => d.value))]).nice()
            .range([height, 0]);

        const color = d3.scaleOrdinal()
            .domain(categories)
            .range(d3.schemeCategory10);

        const svg = d3.select(selector)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 添加 X 轴
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x0))
          .selectAll("text")
            .attr("transform", "rotate(-45)")
            .style("text-anchor", "end");

        // 添加 Y 轴
        svg.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y));

        // 添加网格线
        svg.append("g")
            .attr("class", "grid")
            .call(makeGridLines(y)
                .tickSize(-width)
                .tickFormat("")
            );

        // 创建分组柱形
        const groups = svg.selectAll(".bar-group")
            .data(seriesData)
            .enter().append("g")
            .attr("class", "bar-group")
            .attr("transform", (d, i) => `translate(${x0(`기간 ${i + 1}`)},0)`);

        groups.selectAll(".bar")
            .data(d => d)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", d => x1(d.name))
            .attr("y", d => y(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => height - y(d.value))
            .style("fill", d => color(d.name))
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`类别: ${d.name}<br/>기간: ${d.group}<br/>값: ${d.value.toFixed(2)}`)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .style("transform", "scale(1.1)");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                d3.select(this)
                    .style("transform", "scale(1)");
            })
            .on("click", function(event, d) {
                alert(`详细정보:\n类别: ${d.name}\n기간: ${d.group}\n값: ${d.value.toFixed(2)}`);
            });

        // 添加图例
        const legend = svg.append("g")
            .attr("font-size", "12px")
            .attr("transform", `translate(0,${height + 20})`)
            .selectAll("g")
            .data(categories.slice().reverse())
            .enter().append("g")
            .attr("transform", (d, i) => `translate(${i * 120},0)`) 
            .attr("class", "legend-item")
            .on("click", function(event, d) {
                // 过滤并绘制单一类别的折线图
                const filteredData = dataArray.map((entry, index) => ({
                    x: index,
                    y: entry[d]
                }));

                drawDrillDownLineChart(filteredData, d);
            });

        legend.append("rect")
            .attr("x", 0)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", color)
            .attr("opacity", 0.8);

        legend.append("text")
            .attr("x", 20)
            .attr("y", 9)
            .attr("dy", "0.35em")
            .text(d => d);

        // 添加标题
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - margin.top / 2)
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .text(title);

        // 添加提示框
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    }

    // 钻取折线图
    function drawDrillDownLineChart(data, category) {
        const margin = {top: 20, right: 20, bottom: 40, left: 60};
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        const x = d3.scaleLinear()
            .domain([0, data.length - 1])
            .range([0, width]);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.y)]).nice()
            .range([height, 0]);

        const line = d3.line()
            .x(d => x(d.x))
            .y(d => y(d.y));

        // 创建新的 SVG 容器用于钻取图表
        const svg = d3.select("body")
          .append("div")
            .attr("class", "drilldown-chart")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 添加 X 轴
        svg.append("g")
            .attr("class", "axis")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(data.length));

        // 添加 Y 轴
        svg.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y));

        // 添加网格线
        svg.append("g")
            .attr("class", "grid")
            .call(makeGridLines(y, width)
                .tickSize(-width)
                .tickFormat("")
            );

        // 绘制折线
        svg.append("path")
            .datum(data)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke", "green");

        // 添加数据点
        svg.selectAll(".dot")
            .data(data)
            .enter().append("circle")
            .attr("class", "dot")
            .attr("cx", d => x(d.x))
            .attr("cy", d => y(d.y))
            .attr("r", 4)
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`기간: ${d.x + 1}<br/>값: ${d.y.toFixed(2)}`)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .style("transform", "scale(1.1)");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                d3.select(this)
                    .style("transform", "scale(1)");
            });

        // 添加标题
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 0 - margin.top / 2)
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .text(`类别 '${category}' の詳細趋势`);

        // 添加关闭按钮
        const closeButton = d3.select("body")
            .append("button")
            .attr("class", "close-button")
            .style("position", "absolute")
            .style("top", `${window.innerHeight - 550}px`)
            .style("right", "20px")
            .style("z-index", 10)
            .style("padding", "10px 20px")
            .style("background-color", "#f44336")
            .style("color", "white")
            .style("border", "none")
            .style("border-radius", "4px")
            .style("cursor", "pointer")
            .text("关闭")
            .on("click", function() {
                d3.select(this).remove();
                d3.select(".drilldown-chart").remove();
                d3.select(".overlay-background").remove();
            });

        // 添加遮罩层
        const overlay = d3.select("body")
            .append("div")
            .attr("class", "overlay-background")
            .style("position", "fixed")
            .style("top", 0)
            .style("left", 0)
            .style("width", "100%")
            .style("height", "100%")
            .style("background-color", "rgba(0, 0, 0, 0.5)")
            .style("z-index", 9)
            .style("display", "block")
            .on("click", function() {
                d3.select(".close-button").remove();
                d3.select(".drilldown-chart").remove();
                d3.select(this).remove();
            });
    }

    // 绘制饼图/圆环图
    function drawPieChart(selector, data, title) {
        const margin = {top: 20, right: 20, bottom: 20, left: 20};
        const width = 900 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        const radius = Math.min(width, height) / 2 - Math.max(margin.top, margin.bottom);

        const color = d3.scaleOrdinal()
            .domain(data.map(d => d.name))
            .range(d3.schemeCategory10);

        const svg = d3.select(selector)
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const pie = d3.pie()
            .value(d => d.value)
            .sort(null);

        const arcs = svg.selectAll(".arc")
            .data(pie(data))
            .enter().append("g")
            .attr("class", "arc");

        // 绘制扇形
        arcs.append("path")
            .attr("d", d3.arc().innerRadius(0).outerRadius(radius))
            .attr("fill", d => color(d.data.name))
            .on("mouseover", function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(`类别: ${d.data.name}<br/>값: ${d.data.value.toFixed(2)}`)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .style("transform", "scale(1.1)");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
                d3.select(this)
                    .style("transform", "scale(1)");
            })
            .on("click", function(event, d) {
                alert(`详细情報:\n类别: ${d.data.name}\n값: ${d.data.value.toFixed(2)}`);
            });

        // 添加文本标签
        arcs.append("text")
            .attr("transform", d => `translate(${d3.arc().outerRadius(radius + 10).centroid(d)})`)
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(d => d.data.name);

        // 添加图例
        const legend = svg.append("g")
            .attr("font-size", "12px")
            .attr("transform", `translate(${-radius - 60},${-radius - 40})`)
            .selectAll("g")
            .data(data)
            .enter().append("g")
            .attr("transform", (d, i) => `translate(0,${i * 20})`)
            .attr("class", "legend-item");

        legend.append("rect")
            .attr("x", 0)
            .attr("width", 15)
            .attr("height", 15)
            .attr("fill", d => color(d.name))
            .attr("opacity", 0.8);

        legend.append("text")
            .attr("x", 20)
            .attr("y", 9)
            .attr("dy", "0.35em")
            .text(d => `${d.name}: ${d.value.toFixed(2)}`);

        // 添加标题
        svg.append("text")
            .attr("x", 0)
            .attr("y", -radius - 60)
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .text(title);

        // 添加提示框
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    }
</script>
</body>
</html>