<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>LifeOS 可视化</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        section {
            margin-bottom: 40px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #34495e;
            margin-top: 0;
        }
        svg {
            width: 100%;
            height: 500px;
        }
        .chart-container {
            position: relative;
            min-height: 550px;
        }
        .tooltip {
            position: absolute;
            width: 220px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
        /* 修复SVG标题显示不全 */
        .chart-container svg text.chart-title {
            dominant-baseline: middle;
            alignment-baseline: middle;
        }
        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            margin-left: 20px;
        }
        .pie-legend-item {
            display: flex;
            align-items: center;
            margin-right: 24px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .pie-legend-color {
            width: 18px;
            height: 18px;
            margin-right: 6px;
            border-radius: 3px;
            display: inline-block;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: #777;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            svg { height: 300px; }
            .pie-legend { margin-left: 0; }
        }
    </style>
</head>
<body>
    <header>
        <h1>LifeOS 生命操作系统可视化</h1>
        <p>人生意义与价值目标动态展示</p>
    </header>
    <main>
        <section class="chart-container" aria-label="人生意义趋势">
            <h2 id="life-meaning-trend-title">人生意义趋势</h2>
            <svg id="life-meaning-trend"></svg>
            <p id="life-meaning-description">正在展示人生各个周期的意义值变化趋势</p>
        </section>
        <section class="chart-container" aria-label="累计人生意义趋势">
            <h2 id="cumulative-life-meaning-trend-title">累计人生意义趋势</h2>
            <svg id="cumulative-life-meaning-trend"></svg>
            <p id="cumulative-life-meaning-description">正在展示人生各个周期的累计意义值变化趋势</p>
        </section>
        <section class="chart-container" aria-label="价值目标贡献">
            <h2 id="value-goal-contribution-title">价值目标贡献</h2>
            <svg id="value-goal-contribution"></svg>
            <p id="value-goal-contribution-description">正在展示各价值目标在当前周期中的意义贡献</p>
        </section>
        <section class="chart-container" aria-label="累计价值目标贡献">
            <h2 id="cumulative-value-goal-contribution-title">累计价值目标贡献</h2>
            <svg id="cumulative-value-goal-contribution"></svg>
            <p id="cumulative-value-goal-contribution-description">正在展示各价值目标在整个生命周期中的累计意义贡献</p>
        </section>
        <section class="chart-container" aria-label="价值目标贡献占比">
            <h2>价值目标贡献占比</h2>
            <svg id="value-goal-pie-chart"></svg>
            <div id="value-goal-pie-legend" class="pie-legend"></div>
            <p>各价值目标在当前周期的意义贡献占比</p>
        </section>
        <section class="chart-container" aria-label="累计价值目标贡献占比">
            <h2>累计价值目标贡献占比</h2>
            <svg id="cumulative-value-goal-pie-chart"></svg>
            <div id="cumulative-value-goal-pie-legend" class="pie-legend"></div>
            <p>各价值目标在整个生命周期的累计意义贡献占比</p>
        </section>
        <section class="chart-container" aria-label="分类行动数据">
            <h2>分类行动数据</h2>
            <svg id="action-category-chart"></svg>
            <div id="action-category-legend" class="pie-legend"></div>
            <p id="action-category-description">正在展示各分类下的具体行动数据</p>
        </section>
        <section>
            <h2>生命周期阶段</h2>
            <div id="lifespan-stages"><p>数据加载中...</p></div>
        </section>
        <section>
            <h2>推荐信息</h2>
            <div id="recommendation-info"><p>数据加载中...</p></div>
        </section>
        <section>
            <h2>具体行动建议</h2>
            <div id="action-recommendations"><p>数据加载中...</p></div>
        </section>
        <!-- 全局tooltip -->
        <div id="global-tooltip" class="tooltip"></div>
    </main>
    <footer>
        <p>&copy; 2023 LifeOS. 保留所有权利。</p>
    </footer>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // 全局变量用于存储可视化数据
        window.visualizationData = {};

        // 全局tooltip
        const globalTooltip = d3.select("#global-tooltip");

        // 颜色映射
        const goalColors = d3.scaleOrdinal()
            .domain(["健康", "家庭", "事业", "成长", "财富", "兴趣", "社会", "其他"])
            .range(d3.schemeSet2);

        // 新增的分类行动数据颜色映射
        const categoryActionColors = d3.scaleOrdinal(d3.schemeCategory10);

        window.onload = function() {
            fetch('simulation_output.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络响应异常: ${response.statusText}`);
                    }
                    console.log('成功收到响应:', response); // 添加调试信息
                    return response.json();
                })
                .then(data => {
                    console.log('成功解析JSON数据:', data); // 添加调试信息
                    if (data && data.life_meaning_by_goal) {
                        console.log('找到 life_meaning_by_goal 数据:', data.life_meaning_by_goal); // 添加调试信息
                    } else {
                        console.warn('未找到 life_meaning_by_goal 数据'); // 添加调试信息
                    }
                    // 解析数据
                    const lifeMeaningData = data.life_meaning || [];
                    const cumulativeLifeMeaningData = data.cumulative_life_meaning || [];
                    const lifeMeaningByGoal = [];
                    if (data.life_meaning_by_goal && typeof data.life_meaning_by_goal === 'object' && !Array.isArray(data.life_meaning_by_goal)) {
                        lifeMeaningByGoal.push(data.life_meaning_by_goal);
                    } else if (Array.isArray(data.life_meaning_by_goal)) {
                        for (const entry of data.life_meaning_by_goal) {
                            if (typeof entry === 'object' && !Array.isArray(entry)) {
                                lifeMeaningByGoal.push(entry);
                            }
                        }
                    }
                    const cumulativeLifeMeaningByGoal = Array.isArray(data.cumulative_life_meaning_by_goal) ?
                        data.cumulative_life_meaning_by_goal : [];
                    let lifespanStages = [];
                    if (data.lifespan_stages && Array.isArray(data.lifespan_stages)) {
                        lifespanStages = data.lifespan_stages;
                    } else if (data.lifespan_stages && typeof data.lifespan_stages === 'object') {
                        lifespanStages = Object.entries(data.lifespan_stages).map(([key, stage]) => {
                            if (typeof stage === 'object' && !Array.isArray(stage)) {
                                return {
                                    stage_name: stage.stage_name || stage.name || stage.stage || key,
                                    start_age: stage.start_age || stage.min_age || 0,
                                    end_age: stage.end_age || stage.max_age || 0,
                                    age_range: stage.age_range || `${stage.start_age || stage.min_age || 0}-${stage.end_age || stage.max_age || 0}岁`
                                };
                            } else {
                                return {
                                    stage_name: stage.toString(),
                                    start_age: 0,
                                    end_age: 0
                                };
                            }
                        });
                    }
                    
                    // 新增：提取元行动分类数据
                    let actionCategoryData = [];
                    if (data.life_meaning_by_goal && Array.isArray(data.life_meaning_by_goal)) {
                        // 使用已有的life_meaning_by_goal数据
                        actionCategoryData = data.life_meaning_by_goal;
                    } else {
                        // 如果没有现成的数据，创建示例数据
                        const sampleActionData = {};
                        if (data.life_meaning_by_goal && typeof data.life_meaning_by_goal === 'object') {
                            Object.keys(data.life_meaning_by_goal).forEach(key => {
                                // 放宽过滤条件，匹配更多潜在的行动相关键
                                if (key.includes('行动') || key.includes('action') || key.includes('Activity') || 
                                    key.includes('目标') || key.includes('goal') || key.includes('Goal') ||
                                    key.includes('计划') || key.includes('plan') || key.includes('Plan')) {
                                    sampleActionData[key] = data.life_meaning_by_goal[key];
                                }
                            });
                        }
                        if (Object.keys(sampleActionData).length > 0) {
                            actionCategoryData.push(sampleActionData);
                        }
                    }
                    
                    // 添加默认示例数据作为最后的保障
                    if (actionCategoryData.length === 0) {
                        actionCategoryData = [{
                            "工作相关行动": 30,
                            "家庭相关行动": 25,
                            "健康相关行动": 20,
                            "休闲娱乐行动": 15,
                            "社交互动行动": 10
                        }];
                    }
                    
                    window.visualizationData = {
                        lifeMeaningData,
                        cumulativeLifeMeaningData,
                        lifeMeaningByGoal,
                        cumulativeLifeMeaningByGoal,
                        lifespanStages,
                        actionCategoryData  // 添加分类行动数据到全局变量
                    };
                    initializeCharts();
                })
                .catch(error => {
                    alert(`无法加载可视化数据: ${error.message}`);
                });
        };

        function initializeCharts() {
            if (!window.visualizationData || !window.visualizationData.lifeMeaningData || window.visualizationData.lifeMeaningData.length === 0) {
                alert('可视化数据缺失，请检查 simulation_output.json 是否正常生成');
                return;
            }
            const pieData = generatePieData();
            const cumulativePieData = generateCumulativePieData();
            const actionCategoryPieData = generateActionCategoryPieData();  // 新增分类行动数据
            drawLineChart('#life-meaning-trend', window.visualizationData.lifeMeaningData, '人生意义趋势');
            drawLineChart('#cumulative-life-meaning-trend', window.visualizationData.cumulativeLifeMeaningData, '累计人生意义趋势');
            if (window.visualizationData.lifeMeaningByGoal && window.visualizationData.lifeMeaningByGoal.length > 0) {
                drawBarChart('#value-goal-contribution', window.visualizationData.lifeMeaningByGoal, '每个价值目标的人生意义贡献');
                drawBarChart('#cumulative-value-goal-contribution', window.visualizationData.cumulativeLifeMeaningByGoal, '每个价值目标的累计人生意义贡献');
            } else {
                document.getElementById('value-goal-contribution').style.display = 'none';
                document.getElementById('cumulative-value-goal-contribution').style.display = 'none';
                document.querySelector('#value-goal-contribution + p').textContent = '暂无价值目标数据';
                document.querySelector('#cumulative-value-goal-contribution + p').textContent = '暂无累计价值目标数据';
            }
            if (pieData && pieData.length > 0) {
                drawPieChart('#value-goal-pie-chart', pieData, '每个价值目标的人生意义贡献占比', '#value-goal-pie-legend');
            } else {
                document.getElementById('value-goal-pie-chart').style.display = 'none';
                document.getElementById('value-goal-pie-legend').innerHTML = '';
            }
            if (cumulativePieData && cumulativePieData.length > 0) {
                drawPieChart('#cumulative-value-goal-pie-chart', cumulativePieData, '每个价值目标的累计人生意义贡献占比', '#cumulative-value-goal-pie-legend');
            } else {
                document.getElementById('cumulative-value-goal-pie-chart').style.display = 'none';
                document.getElementById('cumulative-value-goal-pie-legend').innerHTML = '';
            }
            // 新增：绘制分类行动数据饼图
            if (actionCategoryPieData && actionCategoryPieData.length > 0) {
                drawPieChart('#action-category-chart', actionCategoryPieData, '各分类下的具体行动数据', '#action-category-legend');
                // 新增调试信息输出
                console.log('成功生成分类行动数据:', actionCategoryPieData);
            } else {
                document.getElementById('action-category-chart').style.display = 'none';
                document.getElementById('action-category-legend').innerHTML = '';
                // 更新描述文本为更明确的信息
                const descriptionElement = document.querySelector('#action-category-description');
                if (descriptionElement) {
                    descriptionElement.textContent = '暂无有效的分类行动数据可供展示。';
                }
                // 新增空数据时的提示信息
                console.warn('未找到有效的分类行动数据');
            }
            displayLifespanStages();
            addRecommendationInfo();
            addActionRecommendations();  // 新增具体行动建议
        }

        function drawLineChart(selector, data, title) {
            const margin = {top: 40, right: 30, bottom: 50, left: 60};
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;
            d3.select(selector).selectAll("*").remove();
            const svg = d3.select(selector)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            const x = d3.scaleLinear()
                .domain([0, 80])  // 设置最大刻度为80岁
                .range([0, width]);
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d)]).nice()
                .range([height, 0]);
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d => `${d}岁`));
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).tickFormat(d => `${d}意义值`));
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(""));
            const line = d3.line()
                .x((d, i) => x(i))
                .y(d => y(d));
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#3498db")
                .attr("stroke-width", 2)
                .attr("d", line);
            svg.selectAll("circle")
                .data(data)
                .enter().append("circle")
                .attr("cx", (d, i) => x(i))
                .attr("cy", d => y(d))
                .attr("r", 4)
                .attr("fill", "#3498db")
                .on("mouseover", function(event, d, i) {
                    globalTooltip
                        .style("display", "block")
                        .html(`<strong>周期: ${data.indexOf(d)+1}</strong><br/>값: ${d.toFixed(2)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px");
                })
                .on("mousemove", function(event) {
                    globalTooltip
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px");
                })
                .on("mouseout", function() {
                    globalTooltip.style("display", "none");
                });
            svg.append("text")
                .attr("class", "chart-title")
                .attr("x", (width / 2))
                .attr("y", -20)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .text(title);
        }

        function drawBarChart(selector, data, title) {
            const margin = {top: 40, right: 20, bottom: 80, left: 60};
            const width = 900 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;
            d3.select(selector).selectAll("*").remove();
            if (!data || data.length === 0) {
                const svg = d3.select(selector)
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .text("暂无数据可供展示");
                return;
            }
            const latest = Array.isArray(data) ? data[data.length - 1] : data;
            const entries = Object.entries(latest).filter(([k, v]) => typeof v === "number" && !isNaN(v));
            const x = d3.scaleBand()
                .domain(entries.map(d => d[0]))
                .range([0, width])
                .padding(0.2);
            const y = d3.scaleLinear()
                .domain([0, d3.max(entries, d => d[1])]).nice()
                .range([height, 0]);
            const svg = d3.select(selector)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));
            svg.selectAll(".tick text")
                .style("text-anchor", "end")
                .attr("dx", "-0.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y).tickFormat(d => `${d}意义값`));
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(""));
            svg.selectAll(".bar")
                .data(entries)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]))
                .attr("y", d => y(d[1]))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d[1]))
                .attr("fill", d => goalColors(d[0]))
                .on("mouseover", function(event, d) {
                    globalTooltip
                        .style("display", "block")
                        .html(`<strong>${d[0]}</strong><br/>값: ${d[1].toFixed(2)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px");
                })
                .on("mousemove", function(event) {
                    globalTooltip
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px");
                })
                .on("mouseout", function() {
                    globalTooltip.style("display", "none");
                });
            svg.append("text")
                .attr("class", "chart-title")
                .attr("x", (width / 2))
                .attr("y", -20)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .text(title);
        }

        // 优化后的饼状图，避免名称重叠，图例完整展示
        function drawPieChart(selector, data, title, legendSelector) {
            const width = 900;
            const height = 500;
            const radius = Math.min(width, height) / 2 - 40;
            d3.select(selector).selectAll("*").remove();
            if (!data || data.length === 0) {
                const svg = d3.select(selector)
                    .attr("width", width)
                    .attr("height", height);
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .style("font-size", "18px")
                    .text("暂无数据可供展示");
                if (legendSelector) document.querySelector(legendSelector).innerHTML = '';
                return;
            }
            const color = goalColors.domain(data.map(d => d.name));
            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(radius * 0.4).outerRadius(radius);
            // 标签远离中心
            const labelArc = d3.arc().innerRadius(radius * 0.7).outerRadius(radius * 0.7);
            const svg = d3.select(selector)
                .attr("width", width)
                .attr("height", height)
              .append("g")
                .attr("transform", `translate(${width/2},${height/2})`);
            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc")
                .on("mouseover", function(event, d) {
                    d3.select(this).select("path")
                        .transition().duration(200)
                        .attr("transform", "scale(1.08)");
                    globalTooltip
                        .style("display", "block")
                        .html(`<strong>${d.data.name}</strong><br/>값: ${d.data.value.toFixed(2)}<br/>占比: ${((d.endAngle - d.startAngle) * 100 / (2 * Math.PI)).toFixed(1)}%`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px");
                })
                .on("mousemove", function(event) {
                    globalTooltip
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).select("path")
                        .transition().duration(200)
                        .attr("transform", "scale(1)");
                    globalTooltip.style("display", "none");
                });
            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => goalColors(d.data.name));

            // 只在占比大于6%的扇区上显示标签，其余只显示百分比
            arcs.append("text")
                .filter(d => ((d.endAngle - d.startAngle) * 100 / (2 * Math.PI)) > 6)
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .style("font-size", "13px")
                .text(d => `${d.data.name}: ${((d.endAngle - d.startAngle) * 100 / (2 * Math.PI)).toFixed(1)}%`);

            // 对于小于等于6%的块，仅显示百分比
            arcs.append("text")
                .filter(d => ((d.endAngle - d.startAngle) * 100 / (2 * Math.PI)) <= 6)
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", ".35em")
                .style("text-anchor", "middle")
                .style("font-size", "11px")
                .text(d => `${((d.endAngle - d.startAngle) * 100 / (2 * Math.PI)).toFixed(1)}%`);

            svg.append("text")
                .attr("class", "chart-title")
                .attr("y", -radius - 20)
                .attr("x", 0)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .text(title);

            // 图例用HTML渲染，保证完整显示
            if (legendSelector) {
                const legendDiv = document.querySelector(legendSelector);
                if (legendDiv) {
                    legendDiv.innerHTML = '';
                    data.forEach(d => {
                        const item = document.createElement('div');
                        item.className = 'pie-legend-item';
                        const colorBox = document.createElement('span');
                        colorBox.className = 'pie-legend-color';
                        colorBox.style.background = goalColors(d.name);
                        item.appendChild(colorBox);
                        const label = document.createElement('span');
                        label.textContent = d.name;
                        item.appendChild(label);
                        legendDiv.appendChild(item);
                    });
                }
            }
        }

        function generatePieData() {
            if (!window.visualizationData || !window.visualizationData.lifeMeaningByGoal || window.visualizationData.lifeMeaningByGoal.length === 0) {
                return [];
            }
            const latestGoalData = Array.isArray(window.visualizationData.lifeMeaningByGoal) ?
                window.visualizationData.lifeMeaningByGoal[window.visualizationData.lifeMeaningByGoal.length - 1] :
                window.visualizationData.lifeMeaningByGoal;
            if (typeof latestGoalData === 'object' && !Array.isArray(latestGoalData)) {
                return Object.entries(latestGoalData)
                    .filter(([name, value]) => typeof value === 'number' && !isNaN(value) && value > 0)
                    .map(([name, value]) => ({ name, value }));
            }
            return [];
        }

        function generateCumulativePieData() {
            if (!window.visualizationData || !window.visualizationData.cumulativeLifeMeaningByGoal || window.visualizationData.cumulativeLifeMeaningByGoal.length === 0) {
                return [];
            }
            const latestCumulativeData = Array.isArray(window.visualizationData.cumulativeLifeMeaningByGoal) ?
                window.visualizationData.cumulativeLifeMeaningByGoal[window.visualizationData.cumulativeLifeMeaningByGoal.length - 1] :
                window.visualizationData.cumulativeLifeMeaningByGoal;
            if (typeof latestCumulativeData === 'object' && !Array.isArray(latestCumulativeData)) {
                return Object.entries(latestCumulativeData)
                    .filter(([name, value]) => typeof value === 'number' && !isNaN(value) && value > 0)
                    .map(([name, value]) => ({ name, value }));
            }
            return [];
        }

        // 新增生成分类行动数据饼图函数
        function generateActionCategoryPieData() {
            if (!window.visualizationData || !window.visualizationData.actionCategoryData || window.visualizationData.actionCategoryData.length === 0) {
                return [];
            }
            
            // 获取最新周期的数据
            const latestActionCategoryData = Array.isArray(window.visualizationData.actionCategoryData) ?
                window.visualizationData.actionCategoryData[window.visualizationData.actionCategoryData.length - 1] :
                window.visualizationData.actionCategoryData;
            
            if (typeof latestActionCategoryData === 'object' && !Array.isArray(latestActionCategoryData)) {
                console.log('原始分类行动数据:', latestActionCategoryData); // 调试信息
                // 新增：直接提取所有数值大于 0.001 的字段作为有效数据
                return Object.entries(latestActionCategoryData)
                    .filter(([name, value]) => {
                        return typeof value === 'number' && !isNaN(value) && value > 0.001;
                    })
                    .map(([name, value]) => ({ name, value }));
            }
            return [];
        }

        function displayLifespanStages() {
            const stageContainer = document.getElementById('lifespan-stages');
            if (!stageContainer) return;
            stageContainer.innerHTML = '';
            if (!window.visualizationData || !window.visualizationData.lifespanStages || !Array.isArray(window.visualizationData.lifespanStages) || window.visualizationData.lifespanStages.length === 0) {
                const defaultStage = document.createElement('p');
                defaultStage.textContent = '暂无生命周期阶段信息';
                defaultStage.style.color = '#666';
                defaultStage.style.fontStyle = 'italic';
                stageContainer.appendChild(defaultStage);
                return;
            }
            const title = document.createElement('h3');
            title.textContent = '生命周期阶段信息';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '15px';
            stageContainer.appendChild(title);
            const stageList = document.createElement('ul');
            stageList.style.listStyleType = 'none';
            stageList.style.paddingLeft = '0';
            for (const stage of window.visualizationData.lifespanStages) {
                let stageName = '未知阶段';
                let startAge = 0;
                let endAge = 0;
                if (typeof stage === 'object') {
                    stageName = stage.stage_name || stage.name || stage.stage || '未知阶段';
                    if (stage.age_range) {
                        const ageMatch = stage.age_range.match(/(\d+)-(\d+)/);
                        if (ageMatch) {
                            startAge = parseInt(ageMatch[1]);
                            endAge = parseInt(ageMatch[2]);
                        }
                    } else {
                        startAge = stage.start_age || stage.min_age || 0;
                        endAge = stage.end_age || stage.max_age || 0;
                    }
                } else if (typeof stage === 'string') {
                    stageName = stage;
                }
                const listItem = document.createElement('li');
                listItem.style.margin = '8px 0';
                listItem.innerHTML = `<strong>${stageName}</strong>: ${startAge} - ${endAge} 岁`;
                stageList.appendChild(listItem);
            }
            stageContainer.appendChild(stageList);
        }

        function addRecommendationInfo() {
            const recommendationContainer = document.getElementById('recommendation-info');
            if (!recommendationContainer) return;
            recommendationContainer.innerHTML = '';
            const title = document.createElement('h3');
            title.textContent = '推荐信息';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '15px';
            recommendationContainer.appendChild(title);
            if (!window.visualizationData || !window.visualizationData.lifeMeaningByGoal || window.visualizationData.lifeMeaningByGoal.length === 0) {
                const noData = document.createElement('p');
                noData.textContent = '暂无推荐信息可供展示';
                noData.style.color = '#666';
                noData.style.fontStyle = 'italic';
                recommendationContainer.appendChild(noData);
                return;
            }
            const latestGoalData = window.visualizationData.lifeMeaningByGoal[window.visualizationData.lifeMeaningByGoal.length - 1];
            if (typeof latestGoalData !== 'object' || Array.isArray(latestGoalData)) {
                const invalidData = document.createElement('p');
                invalidData.textContent = '推荐信息数据格式错误';
                invalidData.style.color = '#666';
                invalidData.style.fontStyle = 'italic';
                recommendationContainer.appendChild(invalidData);
                return;
            }
            let currentStage = null;
            const currentAge = 30; // 可根据实际需求动态获取
            if (window.visualizationData.lifespanStages && Array.isArray(window.visualizationData.lifespanStages)) {
                for (const stage of window.visualizationData.lifespanStages) {
                    if (typeof stage === 'object') {
                        let startAge = stage.start_age || stage.min_age || 0;
                        let endAge = stage.end_age || stage.max_age || 0;
                        if (currentAge >= startAge && currentAge <= endAge) {
                            currentStage = stage;
                            break;
                        }
                    }
                }
            }
            const recommendations = [];
            const sortedGoals = Object.entries(latestGoalData)
                .filter(([goal, value]) => value > 0.001)
                .sort((a, b) => b[1] - a[1]);
            for (let i = 0; i < Math.min(3, sortedGoals.length); i++) {
                const [goal, value] = sortedGoals[i];
                recommendations.push({
                    title: `${goal}（权重: ${(value * 100).toFixed(1)}%）`,
                    description: `建议重点投入此价值目标，因其在当前周期内具有较高的人生意义贡献。`
                });
            }
            if (currentStage && typeof currentStage === 'object') {
                const stageName = currentStage.stage_name || '未知阶段';
                const stageDescription = `您目前处于${stageName}阶段，这是人生的重要时期，建议关注以下几个方面：`;
                recommendations.push({
                    title: `阶段推荐：${stageName}`,
                    description: stageDescription
                });
                if (stageName === '青年期') {
                    recommendations.push({
                        title: '职业发展',
                        description: '建议加强职业技能的学习与积累，同时拓展人脉资源，为未来的职业道路打下坚实基础。'
                    });
                    recommendations.push({
                        title: '人际关系',
                        description: '建立和维护良好的人际关系网络，有助于未来的个人成长和事业发展。'
                    });
                } else if (stageName === '中年期') {
                    recommendations.push({
                        title: '财务规划',
                        description: '建议合理进行财务规划，确保家庭经济稳定，并为退休生活做好准备。'
                    });
                    recommendations.push({
                        title: '健康管理',
                        description: '注意身体健康管理，定期体检并保持良好生活习惯。'
                    });
                } else if (stageName === '老年期') {
                    recommendations.push({
                        title: '生活质量',
                        description: '注重生活质量的提升，享受退休生活的同时，保持社交活动。'
                    });
                    recommendations.push({
                        title: '经验传承',
                        description: '将自己的经验与知识传递给下一代，发挥余热。'
                    });
                }
            }
            if (recommendations.length === 0) {
                const noRecommendation = document.createElement('p');
                noRecommendation.textContent = '暂无符合条件的推荐信息';
                noRecommendation.style.color = '#666';
                noRecommendation.style.fontStyle = 'italic';
                recommendationContainer.appendChild(noRecommendation);
                return;
            }
            const recommendationList = document.createElement('ul');
            recommendationList.style.listStyleType = 'none';
            recommendationList.style.paddingLeft = '0';
            for (const rec of recommendations) {
                const listItem = document.createElement('li');
                listItem.style.margin = '8px 0';
                const recTitle = document.createElement('strong');
                recTitle.textContent = rec.title;
                recTitle.style.display = 'block';
                recTitle.style.marginBottom = '4px';
                const recDescription = document.createElement('span');
                recDescription.textContent = rec.description;
                listItem.appendChild(recTitle);
                listItem.appendChild(recDescription);
                recommendationList.appendChild(listItem);
            }
            recommendationContainer.appendChild(recommendationList);
        }
        
        // 在现有drawPieChart函数后添加新增内容
        function addActionRecommendations() {
            const actionRecommendationContainer = document.getElementById('action-recommendations');
            if (!actionRecommendationContainer) return;
            actionRecommendationContainer.innerHTML = '';
            
            if (!window.visualizationData || !window.visualizationData.actionCategoryData || window.visualizationData.actionCategoryData.length === 0) {
                const noData = document.createElement('p');
                noData.textContent = '暂无行动数据可供推荐';
                noData.style.color = '#666';
                noData.style.fontStyle = 'italic';
                actionRecommendationContainer.appendChild(noData);
                return;
            }
            
            const latestActionCategoryData = window.visualizationData.actionCategoryData[window.visualizationData.actionCategoryData.length - 1];
            if (typeof latestActionCategoryData !== 'object' || Array.isArray(latestActionCategoryData)) {
                const invalidData = document.createElement('p');
                invalidData.textContent = '行动数据格式错误';
                invalidData.style.color = '#666';
                invalidData.style.fontStyle = 'italic';
                actionRecommendationContainer.appendChild(invalidData);
                return;
            }
            
            let currentStage = null;
            const currentAge = 30; // 可根据实际需求动态获取
            if (window.visualizationData.lifespanStages && Array.isArray(window.visualizationData.lifespanStages)) {
                for (const stage of window.visualizationData.lifespanStages) {
                    if (typeof stage === 'object') {
                        let startAge = stage.start_age || stage.min_age || 0;
                        let endAge = stage.end_age || stage.max_age || 0;
                        if (currentAge >= startAge && currentAge <= endAge) {
                            currentStage = stage;
                            break;
                        }
                    }
                }
            }
            
            const recommendations = [];
            const sortedActions = Object.entries(latestActionCategoryData)
                .filter(([action, value]) => value > 0.001)
                .sort((a, b) => b[1] - a[1]);
            
            for (let i = 0; i < Math.min(3, sortedActions.length); i++) {
                const [action, value] = sortedActions[i];
                recommendations.push({
                    title: `${action}`,
                    description: `建议继续加强对${action}这一行动的关注，因为数据显示它对您具有较高的意义值。`
                });
            }
            
            if (currentStage && typeof currentStage === 'object') {
                const stageName = currentStage.stage_name || '未知阶段';
                if (stageName === '青年期') {
                    recommendations.push({
                        title: '职业发展相关行动',
                        description: '建议加强职业技能学习、参与更多项目实践，并积极拓展行业人脉资源。'
                    });
                    recommendations.push({
                        title: '个人成长相关行动',
                        description: '建议制定系统的学习计划，定期进行技能评估，并参与跨部门协作项目提升综合能力。'
                    });
                } else if (stageName === '中年期') {
                    recommendations.push({
                        title: '财务管理相关行动',
                        description: '建议建立完善的家庭财务规划，包括资产配置优化、风险管理和退休金储备等。'
                    });
                    recommendations.push({
                        title: '健康管理相关行动',
                        description: '建议定期进行全面体检，保持规律运动，并注意工作与生活的平衡。'
                    });
                } else if (stageName === '老年期') {
                    recommendations.push({
                        title: '生活质量提升行动',
                        description: '建议培养有益身心的兴趣爱好，适度参与社交活动，享受充实的退休生活。'
                    });
                    recommendations.push({
                        title: '经验传承行动',
                        description: '建议通过指导年轻人、参与社区教育等方式分享您的宝贵经验和知识。'
                    });
                }
            }
            
            if (recommendations.length === 0) {
                const noRecommendation = document.createElement('p');
                noRecommendation.textContent = '暂无符合条件的行动建议';
                noRecommendation.style.color = '#666';
                noRecommendation.style.fontStyle = 'italic';
                actionRecommendationContainer.appendChild(noRecommendation);
                return;
            }
            
            const recommendationList = document.createElement('ul');
            recommendationList.style.listStyleType = 'none';
            recommendationList.style.paddingLeft = '0';
            for (const rec of recommendations) {
                const listItem = document.createElement('li');
                listItem.style.margin = '8px 0';
                const recTitle = document.createElement('strong');
                recTitle.textContent = rec.title;
                recTitle.style.display = 'block';
                recTitle.style.marginBottom = '4px';
                const recDescription = document.createElement('span');
                recDescription.textContent = rec.description;
                listItem.appendChild(recTitle);
                listItem.appendChild(recDescription);
                recommendationList.appendChild(listItem);
            }
            actionRecommendationContainer.appendChild(recommendationList);
        }
        
        // 新增总结与建议部分
        const mainContainer = document.querySelector('main');
        if (!mainContainer) {
            console.warn('未找到 main 容器，无法添加总结部分');
            // return; // 移除非法的 return 语句
            // 用注释代替或者进行默认处理
        }
        
        const summaryContainer = document.createElement('section');
        summaryContainer.className = 'chart-container';
        summaryContainer.setAttribute('aria-label', '生命周期目标实现总结与建议');
        
        const summaryTitle = document.createElement('h2');
        summaryTitle.textContent = '生命周期目标实现总结与建议';
        summaryContainer.appendChild(summaryTitle);
        
        const summaryText = document.createElement('p');
        summaryText.id = 'life-cycle-summary';
        summaryText.style.fontSize = '16px';
        summaryText.style.lineHeight = '1.6';
        summaryText.textContent = '根据当前数据，您在以下方面取得了显著进展：';
        summaryContainer.appendChild(summaryText);
        
        const summaryList = document.createElement('ul');
        summaryList.style.listStyleType = 'disc';
        summaryList.style.paddingLeft = '20px';
        
        // 提取最重要的几个价值目标作为总结内容
        const topGoals = Object.entries(latestGoalData)
            .filter(([goal, value]) => value > 0.5) // 筛选较高权重的目标
            .sort((a, b) => b[1] - a[1]);
        
        if (topGoals.length > 0) {
            for (let i = 0; i < Math.min(5, topGoals.length); i++) {
                const [goal, value] = topGoals[i];
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${goal}</strong>: 权重 ${(value * 100).toFixed(1)}%，建议继续保持并深化投入。`;
                summaryList.appendChild(listItem);
            }
        } else {
            const noSummaryItem = document.createElement('li');
            noSummaryItem.textContent = '暂无显著目标进展数据，请继续努力或检查数据输入是否准确。';
            summaryList.appendChild(noSummaryItem);
        }
        
        const recommendationText = document.createElement('p');
        recommendationText.style.marginTop = '20px';
        recommendationText.style.fontWeight = 'bold';
        recommendationText.textContent = '下一步具体行动建议：';
        summaryContainer.appendChild(recommendationText);
        
        const recommendationList = document.createElement('ul');
        recommendationList.style.listStyleType = 'circle';
        recommendationList.style.paddingLeft = '20px';
        
        // 根据当前阶段生成建议
        if (currentStage && typeof currentStage === 'object') {
            const stageName = currentStage.stage_name || '未知阶段';
            
            if (stageName === '青年期') {
                recommendationList.innerHTML = `
                    <li>加强职业技能学习，参与更多实际项目以积累经验。</li>
                    <li>拓展人脉资源，积极参与行业交流活动。</li>
                    <li>建立良好的人际关系网络，为未来的发展打下基础。</li>
                `;
            } else if (stageName === '中年期') {
                recommendationList.innerHTML = `
                    <li>合理进行财务规划，确保家庭经济稳定。</li>
                    <li>注重健康管理，定期体检并保持良好生活习惯。</li>
                    <li>优化时间管理，平衡工作与个人发展。</li>
                `;
            } else if (stageName === '老年期') {
                recommendationList.innerHTML = `
                    <li>享受退休生活的同时，保持适度的社交活动。</li>
                    <li>将自己的经验与知识传递给下一代。</li>
                    <li>关注生活质量提升，培养兴趣爱好。</li>
                `;
            }
        }
        
        // 默认通用建议
        if (recommendationList.children.length === 0) {
            recommendationList.innerHTML = `
                <li>持续关注高权重价值目标，如健康、家庭、事业发展等。</li>
                <li>设定短期可实现的小目标，逐步推进长期愿景。</li>
                <li>定期回顾和调整目标优先级，确保与人生意义一致。</li>
            `;
        }
        
        summaryContainer.appendChild(summaryList);
        summaryContainer.appendChild(recommendationList);
        mainContainer.appendChild(summaryContainer);
        
    </script>
</body>
</html>